<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{Layout}">
    <head>
        <meta charset="UTF-8">
        <title>Pokédex - Detalle Pokémon</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <style>
            .back-arrow{
                position: absolute;
                top: 35px;
                left: 10px;
                font-size: 1.9rem;
                color: white;
                background: rgba(0,0,0,0.25);
                padding: 0px 14px;
                border-radius: 50%;
                text-decoration: none;
                transition: 0.3s;
            }

            #loader {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                transition: opacity 0.5s ease;
            }
            #loader.hide {
                opacity: 0;
                pointer-events: none;
            }
            .loader-content p {
                color: white;
                font-family: 'PokemonSolid', sans-serif;
                font-size: 0.9rem;
            }
            .pokeball {
                width: 80px;
                height: 80px;
                background: linear-gradient(to bottom, #ff1c1c 50%, #fff 50%);
                border-radius: 50%;
                border: 4px solid #000;
                position: relative;
                animation: spin 1.2s linear infinite;
            }
            .pokeball::before {
                content: "";
                position: absolute;
                top: 50%;
                left: 0;
                width: 100%;
                height: 6px;
                background: #000;
                transform: translateY(-50%);
            }
            .pokeball::after {
                content: "";
                position: absolute;
                top: 50%;
                left: 50%;
                width: 18px;
                height: 18px;
                background: #fff;
                border: 4px solid #000;
                border-radius: 50%;
                transform: translate(-50%, -50%);
            }
            @keyframes spin {
                0% {
                    transform: rotate(0);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            body {
                background-image: url("https://wallpapers.com/images/high/totodile-looking-at-friends-in-creek-lu1576wfu8mk6d0k.webp");
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                background-attachment: fixed;
            }
            .pokedex-header h2 {
                font-family: 'PokemonSolid', cursive;
                font-size: 3rem;
                letter-spacing: 2px;
                color: #fff;
                text-shadow:
                    2px 2px 0 #000,
                    -2px -2px 0 #000,
                    2px -2px 0 #000,
                    -2px 2px 0 #000;
            }

            .pokedex-header::after {
                content: "";
                display: block;
                height: 6px;
                margin-top: 10px;
                background: linear-gradient(to right, transparent, currentColor, transparent);
            }

            .pokedex {
                background: #e63946;
                border-radius: 20px;
                padding: 10px;
                box-shadow: inset 0 0 15px #000;
                backdrop-filter: blur(6px);
                background-color: rgba(230, 57, 70, 0.85);
                opacity: 0.95;
                position: relative;
                overflow: hidden;
            }

            .pokedex::before {
                content: "";
                position: absolute;
                inset: 0;
                border-radius: 20px;
                background: radial-gradient(
                    circle at top left,
                    rgba(255,255,255,0.25),
                    transparent 60%
                    );
                pointer-events: none;
            }

            .pokedex::after {
                content: "";
                position: absolute;
                top: 20px;
                left: 20px;
                width: 14px;
                height: 14px;
                background: #00ff5a;
                border-radius: 50%;
                box-shadow: 0 0 10px #00ff5a;
                animation: blink 1.2s infinite;
            }

            @keyframes blink {
                0%,100% {
                    opacity: 1;
                }
                50% {
                    opacity: .3;
                }
            }

            .badge-type {
                box-shadow: 0 0 8px rgba(0,0,0,.4);
                text-shadow: 0 0 4px rgba(255,255,255,.6);
                transition: transform .2s ease;
            }

            .badge-type:hover {
                transform: scale(1.1);
                transition: .2s;
            }
            .screen {
                background: #f8f9fa;
                position: relative;
                border: 5px solid #000;
                border-radius: 10px;
                padding: 10px;
                height: 100%;
                animation: popIn 2s ease;
                box-shadow:
                    inset 3px 3px 6px rgba(255,255,255,.4),
                    inset -3px -3px 6px rgba(0,0,0,.4),
                    0 4px 8px rgba(0,0,0,.6);
            }

            .screen::after {
                content: "";
                position: absolute;
                inset: 0;
                background: repeating-linear-gradient(
                    to bottom,
                    rgba(0,0,0,.08),
                    rgba(0,0,0,.08) 1px,
                    transparent 1px,
                    transparent 3px
                    );
                pointer-events: none;
                border-radius: 10px;
            }

            .screen-auto {
                height: auto !important;
            }
            .chart-container {
                max-width: 250px;
                margin: 0 auto;
            }

            @keyframes popIn {
                from {
                    opacity: 0;
                    transform: scale(.96);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            @keyframes slideIn {
                from {
                    transform: translateY(30px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            @keyframes float {
                0%,100% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(-10px);
                }
            }

            .pokemon-img {
                max-height: 250px;
                animation: float 1.5s ease-in-out infinite;
                filter: drop-shadow(0 0 15px rgba(255,255,255,.6));
            }

            .favorite {
                position: absolute;
                top: 10px;
                right: 10px;
                font-size: 1.8rem;
            }

            .favorite.active {
                color: gold;
                animation: pulseStar .4s ease;
            }

            @keyframes pulseStar {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.4);
                }
                100% {
                    transform: scale(1);
                }
            }

            .favorite:hover {
                transform: scale(1.2);
            }

            .badge-type {
                font-size: 1rem;
                margin-right: 5px;
                padding: 8px;
            }

            .carousel-control-prev-icon,
            .carousel-control-next-icon {
                filter: invert(1);
                background-color: rgba(0,0,0,.6);
                border-radius: 50%;
                padding: 15px;
            }

            #pokemon-types span,
            #pokemon-weaknesses span,
            #pokemon-resistances span {
                display: inline-block;
                margin: 4px;
            }
            #pokemon-evolutions img {
                background: #444;
                padding: 6px;
                border-radius: 50%;
            }

            #pokemon-evolutions div:hover {
                transform: scale(1.05);
                transition: 0.3s;
            }
            #pokemon-evolutions div {
                transform-style: preserve-3d;
                transition: transform .3s;
            }

            #pokemon-evolutions div:hover {
                transform: rotateY(10deg) scale(1.05);
            }
            canvas {
                filter: drop-shadow(0 4px 6px rgba(0,0,0,.4));
            }

            #pokemon-evolutions div::after {
                content: "→";
                margin-left: 10px;
                font-size: 1.5rem;
            }
            #pokemon-evolutions div:last-child::after {
                content: "";
            }

            #pokemon-id,
            #pokemon-weight,
            #pokemon-height {
                font-family: "Press Start 2P";
                letter-spacing: 2px;
            }

            .toast-favorito {
                position: fixed;
                bottom: 60px;
                right: 825px;
                background: #667eea;
                color: white;
                padding: 14px 20px;
                border-radius: 12px;
                font-weight: bold;
                box-shadow: 0 8px 20px rgba(0,0,0,0.3);
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.4s ease;
                z-index: 9999;
            }

            .toast-favorito.show {
                opacity: 1;
                transform: translateY(0);
            }

            .toast-favorito.error {
                background: #dc3545;
            }

            .toast-favorito.remove {
                background: #6c757d;
            }

            .evolution-card:hover {
                transform: scale(1.1);
                transition: 0.2s;
            }
        </style>
    </head>
    <body layout:fragment="content">
        <div id="loader" >
            <div class="loader-content text-center">
                <div class="pokeball text-center"></div>
                <p class="mt-3 text-center">Cargando Pokédex...</p>
            </div>
        </div>

        <div class="container my-4">
            <div class="pokedex">
                <div class="pokedex-header text-center mb-3">
                    <h2 id="pokemon-name">CARGANDO...</h2>
                </div>
                <a th:href="@{/pokedex}" class="back-arrow">❮</a>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="screen screen-auto text-center">
                            <i class="bi bi-star favorite" id="favoriteBtn"></i>
                            <img id="pokemon-image" class="img-fluid pokemon-img my-3">
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="screen">
                            <ul class="list-group list-group-flush text-center">
                                <li class="list-group-item"><strong># Pokédex:</strong> <span id="pokemon-id"></span></li>
                                <li class="list-group-item"><strong>Peso:</strong> <span id="pokemon-weight"></span> kg</li>
                                <li class="list-group-item"><strong>Altura:</strong> <span id="pokemon-height"></span> m</li>
                                <li class="list-group-item"><strong>Habilidad:</strong> <span id="pokemon-ability"></span></li>
                                <li class="list-group-item">
                                    <strong>Descripción:</strong>
                                    <p id="pokemon-description" class="mt-2"></p>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mt-3">
                    <div class="col-md-4 text-center">
                        <div class="screen text-center">
                            <h5>Tipos</h5>
                            <div id="pokemon-types" class="mb-2"></div>
                            <h6 class="mt-3">Débil contra</h6>
                            <div id="pokemon-weaknesses" class="mb-2"></div>
                            <h6 class="mt-3">Resiste</h6>
                            <div id="pokemon-resistances" class="mb-2"></div>
                            <hr>
                            <h6>Perfil</h6>
                            <p class="mb-1"><strong>Hábitat:</strong> <span id="pokemon-habitat"></span></p>
                            <p class="mb-0"><strong>Generación:</strong> <span id="pokemon-generation"></span></p>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="screen">
                            <div id="pokemonCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner text-center">
                                    <div class="carousel-item active">
                                        <h5>Estadísticas</h5>
                                        <div class="chart-container">
                                            <canvas id="statsChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="carousel-item">
                                        <h5>Ataques</h5>
                                        <ul id="pokemon-moves" class="list-group"></ul>
                                    </div>
                                    <div class="carousel-item">
                                        <h5>Evoluciones</h5>
                                        <div id="pokemon-evolutions" class="d-flex justify-content-center gap-3"></div>
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#pokemonCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#pokemonCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            const typeColors = {
                fire: "#f08030", water: "#6890f0", grass: "#78c850", electric: "#f8d030",
                ice: "#98d8d8", fighting: "#c03028", poison: "#a040a0", ground: "#e0c068",
                flying: "#a890f0", psychic: "#f85888", bug: "#a8b820", rock: "#b8a038",
                ghost: "#705898", dragon: "#7038f8", dark: "#705848", steel: "#b8b8d0",
                fairy: "#ee99ac", normal: "#a8a878"
            };

            const typeEffectiveness = {
                normal: {weak: ["fighting"], resist: []},
                fire: {weak: ["water", "rock", "ground"], resist: ["fire", "grass", "ice", "bug", "steel", "fairy"]},
                water: {weak: ["electric", "grass"], resist: ["fire", "water", "ice", "steel"]},
                grass: {weak: ["fire", "ice", "bug", "flying", "poison"], resist: ["water", "electric", "grass", "ground"]},
                electric: {weak: ["ground"], resist: ["electric", "flying", "steel"]},
                ice: {weak: ["fire", "fighting", "rock", "steel"], resist: ["ice"]},
                fighting: {weak: ["flying", "psychic", "fairy"], resist: ["bug", "rock", "dark"]},
                poison: {weak: ["ground", "psychic"], resist: ["grass", "fighting", "poison", "bug", "fairy"]},
                ground: {weak: ["water", "grass", "ice"], resist: ["poison", "rock"]},
                flying: {weak: ["electric", "ice", "rock"], resist: ["grass", "fighting", "bug"]},
                psychic: {weak: ["bug", "ghost", "dark"], resist: ["fighting", "psychic"]},
                bug: {weak: ["fire", "flying", "rock"], resist: ["grass", "fighting", "ground"]},
                rock: {weak: ["water", "grass", "fighting", "ground", "steel"], resist: ["fire", "normal", "flying", "poison"]},
                ghost: {weak: ["ghost", "dark"], resist: ["poison", "bug"]},
                dragon: {weak: ["ice", "dragon", "fairy"], resist: ["fire", "water", "grass", "electric"]},
                dark: {weak: ["fighting", "bug", "fairy"], resist: ["ghost", "dark"]},
                steel: {weak: ["fire", "fighting", "ground"], resist: ["normal", "grass", "ice", "flying", "psychic", "bug", "rock", "dragon", "steel", "fairy"]},
                fairy: {weak: ["poison", "steel"], resist: ["fighting", "bug", "dark"]}
            };

            function getPokemonIdFromURL() {
                return window.location.pathname.split("/").pop();
            }

            async function fetchJsonSafe(url) {
                const res = await fetch(url);
                if (!res.ok)
                    return null;
                return res.json();
            }

            /* ================= FAVORITOS ================= */

            async function verificarFavorito(idPokemon) {
                try {
                    const res = await fetch("/pokedex/favoritos", {credentials: "same-origin"});
                    const favoritos = await res.json();
                    return favoritos.includes(parseInt(idPokemon));
                } catch {
                    return false;
                }
            }

            function initFavorito(pokemon) {
                const star = document.getElementById("favoriteBtn");
                if (!star)
                    return;

                verificarFavorito(pokemon.id).then(esFavorito => {
                    if (esFavorito) {
                        star.classList.add("bi-star-fill", "active");
                        star.classList.remove("bi-star");
                    } else {
                        star.classList.add("bi-star");
                        star.classList.remove("bi-star-fill", "active");
                    }
                });

                star.addEventListener("click", () => {
                    const esActivo = star.classList.contains("active");
                    const url = esActivo ? "/pokedex/deleteFavorito" : "/pokedex/addFavorito";

                    const params = new URLSearchParams();
                    params.append("idPokemon", pokemon.id);
                    if (!esActivo)
                        params.append("nombrePokemon", pokemon.name);

                    fetch(url, {
                        method: "POST",
                        headers: {"Content-Type": "application/x-www-form-urlencoded"},
                        body: params,
                        credentials: "same-origin"
                    })
                            .then(r => r.json())
                            .then(res => {
                                if (!res.correct) {
                                    alert(res.errorMessage);
                                    return;
                                }

                                star.classList.toggle("bi-star");
                                star.classList.toggle("bi-star-fill");
                                star.classList.toggle("active");

                                alert(esActivo
                                        ? "❌ Pokémon eliminado de favoritos"
                                        : "⭐ Pokémon agregado a favoritos"
                                        );
                            });
                });
            }

            /* ================= CARGA PRINCIPAL ================= */

            const pokemonId = getPokemonIdFromURL();
            const startTime = Date.now();

            (async () => {
                try {
                    const pokemon = await fetchJsonSafe(`https://pokeapi.co/api/v2/pokemon/${pokemonId}`);
                    if (!pokemon)
                        throw new Error("Pokémon no encontrado");

                    const species = await fetchJsonSafe(`https://pokeapi.co/api/v2/pokemon-species/${pokemonId}`);

                    renderPokemon(pokemon, species);
                    initFavorito(pokemon);

                    const loader = document.getElementById("loader");
                    const remaining = Math.max(1500 - (Date.now() - startTime), 0);
                    setTimeout(() => loader?.remove(), remaining);

                } catch (err) {
                    console.error(err);
                    document.querySelector(".pokedex").innerHTML = `
                <h3 class="text-center mt-4">⚠️ Pokémon no encontrado</h3>
            `;
                }
            })();

            /* ================= RENDER ================= */

            function renderPokemon(pokemon, species) {
                document.getElementById("pokemon-name").textContent = pokemon.name.toUpperCase();
                document.getElementById("pokemon-id").textContent = pokemon.id;
                document.getElementById("pokemon-weight").textContent = pokemon.weight / 10;
                document.getElementById("pokemon-height").textContent = pokemon.height / 10;
                document.getElementById("pokemon-ability").textContent =
                        pokemon.abilities[0]?.ability.name ?? "—";

                document.getElementById("pokemon-image").src =
                        pokemon.sprites.other?.home?.front_default || pokemon.sprites.front_default;

                renderTypes(pokemon.types);
                setPokedexColor(pokemon.types[0].type.name);
                renderStats(pokemon.stats);
                renderMoves(pokemon.moves);
                renderWeaknessesAndResistances(pokemon.types);

                if (species) {
                    const desc = species.flavor_text_entries.find(e => e.language.name === "es");
                    document.getElementById("pokemon-description").textContent =
                            desc ? desc.flavor_text.replace(/\f/g, " ") : "Sin descripción";

                    document.getElementById("pokemon-habitat").textContent =
                            species.habitat?.name ?? "Desconocido";

                    document.getElementById("pokemon-generation").textContent =
                            species.generation.name.replace("generation-", "").toUpperCase();

                    renderEvolutions(species);
                }
            }

            function renderTypes(types) {
                const container = document.getElementById("pokemon-types");
                container.innerHTML = "";
                types.forEach(t => {
                    const badge = document.createElement("span");
                    badge.className = "badge badge-type text-white";
                    badge.style.backgroundColor = typeColors[t.type.name];
                    badge.textContent = t.type.name.toUpperCase();
                    container.appendChild(badge);
                });
            }

            function setPokedexColor(type) {
                document.querySelector(".pokedex").style.background =
                        `linear-gradient(135deg, ${typeColors[type]}, #e63946)`;
            }

            function renderStats(stats) {
                new Chart(document.getElementById("statsChart"), {
                    type: "radar",
                    data: {
                        labels: stats.map(s => s.stat.name.toUpperCase()),
                        datasets: [{data: stats.map(s => s.base_stat), borderWidth: 3}]
                    },
                    options: {responsive: true}
                });
            }

            function renderMoves(moves) {
                const list = document.getElementById("pokemon-moves");
                list.innerHTML = "";
                moves.slice(0, 5).forEach(m => {
                    const li = document.createElement("li");
                    li.className = "list-group-item";
                    li.textContent = m.move.name;
                    list.appendChild(li);
                });
            }

            function renderWeaknessesAndResistances(types) {
                const weak = new Set(), resist = new Set();
                types.forEach(t => {
                    const d = typeEffectiveness[t.type.name];
                    d?.weak.forEach(w => weak.add(w));
                    d?.resist.forEach(r => resist.add(r));
                });
                renderBadges("pokemon-weaknesses", weak);
                renderBadges("pokemon-resistances", resist);
            }

            function renderBadges(id, set) {
                const c = document.getElementById(id);
                c.innerHTML = "";
                set.forEach(v => {
                    const b = document.createElement("span");
                    b.className = "badge badge-type text-white";
                    b.style.backgroundColor = typeColors[v];
                    b.textContent = v.toUpperCase();
                    c.appendChild(b);
                });
            }

            async function renderEvolutions(species) {
                const c = document.getElementById("pokemon-evolutions");
                const evo = await fetchJsonSafe(species.evolution_chain.url);
                if (!evo)
                    return;

                let chain = evo.chain;
                while (chain) {
                    const p = await fetchJsonSafe(`https://pokeapi.co/api/v2/pokemon/${chain.species.name}`);
                    if (p)
                        c.appendChild(createEvolutionCard(p));
                    chain = chain.evolves_to[0];
                }
            }

            function createEvolutionCard(pokemon) {
                const card = document.createElement("div");
                card.className = "text-center evolution-card";
                card.onclick = () => location.href = `/pokedex/detail/${pokemon.id}`;

                const img = document.createElement("img");
                img.src = pokemon.sprites.other["official-artwork"].front_default;
                img.style.width = "100px";

                const name = document.createElement("p");
                name.textContent = pokemon.name.toUpperCase();

                card.append(img, name);
                return card;
            }

            function mostrarToast(mensaje, tipo = "success") {
                const toast = document.createElement('div');
                toast.className = `toast-favorito ${tipo}`;
                toast.textContent = mensaje;

                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 100);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 400);
                }, 2500);
            }
        </script>

    </body>
</html>
